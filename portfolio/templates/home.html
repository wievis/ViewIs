{% extends 'base.html' %}
{% load static %}
{% block title %}Portfolio | Computer Designer{% endblock %}

{% block extra_head %}
<style>
    .gallery { padding: 1rem; max-width: 1400px; margin: 0 auto; }
    .stack-group { position: relative; width: 100%; height: 600px; margin-bottom: 10rem; }
    .stack-item { 
        position: absolute; width: 80%; max-width: 900px; 
        transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1), z-index 0.1s; 
        cursor: pointer; top: 0; 
        touch-action: auto;
    }
    .stack-item img { 
        width: 100%; 
        height: 600px; 
        object-fit: cover; 
        display: block; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        border-radius: 4px; 
        pointer-events: none; 
    }
    @media (max-width: 768px) { 
        .stack-group { height: 400px; } 
        .stack-item { width: 90%; } 
        .stack-item img { height: 400px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="gallery">
    {% for item in top_level_media %}
        {% if item.media_type == 'album' %}
        <div class="stack-group">
            {% for child in item.children.all %}
            {% if child.file %}
            <div class="stack-item" 
                 onclick="handleStackClick(event, this, '{{ child.file.url }}')" 
                 onmouseenter="throttledReorder(this)"
                 ontouchstart="handleTouchStart(event)"
                 ontouchend="handleTouchEnd(event, this, '{{ child.file.url }}')">
                <img src="{{ child.file.url }}">
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        {% if item.file %}
        <div class="media-item" onclick="openLightboxByUrl('{{ item.file.url }}')">
            <div class="media-content">
                {% if item.media_type == 'image' %}<img src="{{ item.file.url }}" style="height: 600px; object-fit: cover; width: 100%;">
                {% elif item.media_type == 'video' %}<video src="{{ item.file.url }}" autoplay loop muted playsinline style="height: 600px; object-fit: cover; width: 100%;"></video>
                {% elif item.media_type == 'model3d' %}<div class="model-viewer" data-model="{{ item.file.url }}" data-hdr="{% if item.hdr_setting %}{{ item.hdr_setting.file.url }}{% endif %}" style="height: 600px;"></div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endif %}
    {% endfor %}
</div>

<script>
    let lastReorderTime = 0;
    const REORDER_DELAY = 700;
    let touchStartY = 0;
    let touchStartX = 0;

    function throttledReorder(item) {
        const now = Date.now();
        if (now - lastReorderTime >= REORDER_DELAY) {
            reorderStack(item);
            lastReorderTime = now;
        }
    }

    function reorderStack(hoveredItem) {
        const container = hoveredItem.parentElement;
        const items = Array.from(container.querySelectorAll('.stack-item'));
        const total = items.length;
        const hoveredIdx = items.indexOf(hoveredItem);

        items.forEach((item, i) => {
            let relativeIndex = (i - hoveredIdx + total) % total;
            let zIndex = total - relativeIndex;
            item.style.zIndex = zIndex;
            item.style.transform = `translateX(${relativeIndex * 40}px)`;
            item.setAttribute('data-is-top', zIndex === total ? 'true' : 'false');
        });
    }

    function handleTouchStart(e) {
        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].clientX;
    }

    function handleTouchEnd(e, el, url) {
        const touchEndY = e.changedTouches[0].clientY;
        const touchEndX = e.changedTouches[0].clientX;
        
        if (Math.abs(touchStartY - touchEndY) > 10 || Math.abs(touchStartX - touchEndX) > 10) return;

        if (window.innerWidth <= 768) {
            if (el.getAttribute('data-is-top') === 'true') {
                openLightbox(window.mediaItems.findIndex(i => i.url === url));
            } else {
                throttledReorder(el);
            }
        }
    }

    function handleStackClick(event, el, url) {
        if (window.innerWidth > 768) {
            openLightbox(window.mediaItems.findIndex(i => i.url === url));
        }
    }

    window.mediaItems = [
        {% for item in media_items %}{% if item.file %}
        { url: "{{ item.file.url }}", type: "{{ item.media_type }}", hdr: "{% if item.hdr_setting %}{{ item.hdr_setting.file.url }}{% endif %}" }{% if not forloop.last %},{% endif %}
        {% endif %}{% endfor %}
    ];

    function openLightboxByUrl(url) {
        const idx = window.mediaItems.findIndex(i => i.url === url);
        if (idx !== -1) openLightbox(idx);
    }

    document.querySelectorAll('.stack-group').forEach(group => {
        const first = group.querySelector('.stack-item');
        if (first) reorderStack(first);
    });
</script>
{% endblock %}